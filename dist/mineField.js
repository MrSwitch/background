(()=>{window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||(e=>setTimeout(e,1e3/60));var dt=window.requestAnimationFrame.bind(window);var L={bubbles:!0,cancelable:!0},S=(e,t=L)=>new Event(e,t);try{S("test")}catch{S=(e,t=L)=>{let i=document.createEvent("Event");return i.initEvent(e,!!t.bubbles,!!t.cancelable),i}}var w=S;var X=e=>(e.stopPropagation=()=>{},e.preventDefault=()=>{},e);var f=(e,t)=>t&&e instanceof t;var V=typeof HTMLElement<"u"&&HTMLElement||typeof Element<"u"&&Element,K=typeof HTMLDocument<"u"&&HTMLDocument||typeof Document<"u"&&Document,G=window.constructor,Y=e=>f(e,V)||f(e,K)||f(e,G);function Z(e){return Array.prototype.slice.call(e)}var D=Z;function m(e,t=()=>{}){return Y(e)?e=[e]:typeof e=="string"&&(e=document.querySelectorAll(e)),f(e,Array)||(e=D(e)),t&&e.forEach(t),e}var J=/[\s,]+/,j=!1;try{let e=Object.defineProperty({},"passive",{get(){j=!0}});window.addEventListener("test",null,e)}catch{}function c(e,t,i,s=!1){return typeof s=="object"&&s.passive&&!j&&(s=!1),t=t.split(J),m(e,n=>t.forEach(o=>n.addEventListener(o,i,s)))}var T=window.navigator.pointerEnabled,N=T?"MSPointerMove pointerMove":"mousemove touchmove",Q=T?"MSPointerDown pointerDown":"mousedown touchstart",tt=T?"MSPointerUp pointerUp":"mouseup touchend touchcancel";function k(e,t,i,s){let n={},o={},l={};c(document,N,h=>{if(et(h))return;let r=h.pointerId||0,d=n[r];if(d&&typeof d=="function"){let a=o[r];x(h,a),d(h,a)}o[r]=h}),c(document,tt,h=>{let r=h.pointerId||0;n[r]=null,(h.type==="touchend"||h.type==="touchcancel")&&(h=o[r]);let d=l[r];d&&d(h),l[r]=null}),m(e,h=>{c(h,"selectstart",()=>!1),c(h,Q,r=>{let d=r.pointerId||0;x(r),o[d]=r,n[d]=(a,g)=>{t.call(h,a,g,r)},s&&(l[d]=a=>{x(a,r),s.call(h,a,r)}),i&&i.call(h,r)})})}function x(e,t){if(e.gesture={},e&&e.touches&&e.touches.length>0?e.gesture.touches=e.touches:e.gesture.touches=[e],e.gesture.screenX=e.gesture.touches[0].screenX,e.gesture.screenY=e.gesture.touches[0].screenY,"screenX"in e||(e.screenX=e.gesture.screenX),"screenY"in e||(e.screenY=e.gesture.screenY),t){e.gesture.deltaTime=e.timeStamp-t.timeStamp;let i=e.gesture.deltaX=e.gesture.screenX-t.gesture.screenX,s=e.gesture.deltaY=e.gesture.screenY-t.gesture.screenY;Math.abs(s)>Math.abs(i)?e.gesture.direction=s>0?"up":"down":e.gesture.direction=i>0?"right":"left",e.gesture.distance=Math.sqrt(i*i+s*s),e.gesture.velocity=e.gesture.distance/e.gesture.deltaTime}}function et(e){return(e.pointerType||e.type).match(/mouse/i)&&(e.which||e.buttons)!==1}function z(e,t){return k(e,function(s,n,o){x(s,o),s.gesture.type=`drag${s.gesture.direction}`,t.call(this,s)},function(s){s.gesture.type="start",t.call(this,s)},function(s){let n=s.gesture;n.deltaTime<200&&n.distance>20&&n.velocity>.3?n.type=`swipe${n.direction}`:n.distance<20?n.type="click":n.type="release",t.call(this,s)})}var H="background",R=["click","mousedown","mouseup","mouseover","mousemove","mouseout","frame","resize","keydown"],q=["touchmove","touchstart","touchend"],it=/[\s,]+/,b=class{constructor(t){let i;if(this.events={},"getContext"in document.createElement("canvas")){t&&t instanceof HTMLCanvasElement?(this.target=t,i=t.parentNode):(i=t,t=document.createElement("canvas"),t.style.backgroundColor="white",i||(i=document.body,t.style.cssText="position:fixed;z-index:-1;top:0;left:0;",t.setAttribute("tabindex",0),document.documentElement.style.cssText="min-height:100%;",document.body.style.cssText="min-height:100%;",window.addEventListener("resize",this.resize.bind(this))),i.insertBefore(t,i.firstElementChild),this.target=t,this.resize()),this.ctx=t.getContext("2d"),this.ctx.save(),this._time=0,this._fps=0,this.draw(),c(this.target,R.toString(),this.dispatchEvent.bind(this),{passive:!0}),c(this.target,q.toString(),this.dispatchTouchEvent.bind(this),{passive:!0}),i===document.body&&t.style.getPropertyValue("z-index")==="-1"&&(c(document,R.toString(),this.dispatchEvent.bind(this),{passive:!0}),c(document,q.toString(),this.dispatchTouchEvent.bind(this),{passive:!0}));{let s=this.target.style,n=s.getPropertyValue("z-index");window.addEventListener("hashchange",F.bind(s,n)),F.call(s,n)}this.swipe&&z(this.target,this.swipe.bind(this))}}get width(){return this.target.width}set width(t){this.target.width=t}get height(){return this.target.height}set height(t){this.target.height=t}get fps(){return this._fps}set fps(t){this._fps=t;let i=new Date().getTime();i-this._time>1e3&&(this._time=i,this._fps=0)}resize(){let t=this.target.parentNode===document.body?document.documentElement:this.target.parentNode,i=t.clientHeight,s=t.clientWidth,n=!1;this.width!==s&&(n=!0,this.width=s),this.height!==i&&(n=!0,this.height=i),n&&this.target.dispatchEvent(w("resize"))}clear(){this.ctx.clearRect(0,0,this.target.width,this.target.height)}bringToFront(){window.location.hash=H}draw(){this.fps++,this.target.dispatchEvent(w("frame")),requestAnimationFrame(this.draw.bind(this))}addEventListener(t,i){t.split(it).forEach(s=>{s in this.events||(this.events[s]=[]),this.events[s].push(i)})}dispatchEvent(t){t.type in this.events&&(t.currentTarget===document&&(t=X({type:t.type,target:this.target,offsetX:t.pageX||t.offsetX,offsetY:t.pageY||t.offsetY})),this.events[t.type].forEach(s=>s(t)),t.stopPropagation())}dispatchTouchEvent(t){let i=(t.touches||t.changedTouches)[0];i&&(t.offsetX=Math.abs(i.pageX||i.screenX),t.offsetY=Math.abs(i.pageY||i.screenY)),this.dispatchEvent(t)}};function F(e){let t="z-index";window.location.hash===`#${H}`&&(e=1e4),e!==void 0?this.setProperty(t,e):this.removeProperty(t)}var st=["click","mousedown","mouseup","mouseover","mousemove","mouseout","touchmove","touchstart","touchend","frame"],_=class{constructor(t){this.children=[],this.events=[],this.init(t)}init(t){this.target=t,this.ctx=t.getContext("2d"),c(t,st.toString(),this._findAndDispatch.bind(this),{passive:!0})}push(t){t.dirty=!0,this.children.indexOf(t)===-1&&(t.setup&&t.setup(this),this.children.push(t))}findIndex(t){return this.children.findIndex(t)}find(t){return this.children.find(t)}get length(){return this.children.length}set length(t){this.children.length=t}prepare(){this.children.forEach(t=>{t.dirty===!0&&this.prepareChild(t)})}prepareChild(t){let i=this.ctx;t.dirty!=="pending"&&(t.dirty="pending",i.clearRect(t.x,t.y,t.w,t.h),t.previous&&nt(t.previous,t)&&i.clearRect(t.previous.x,t.previous.y,t.previous.w,t.previous.h),this.children.forEach(this._prepareSiblings.bind(this,t)))}_prepareSiblings(t,i){!i.dirty&&i.visible!==!1&&(M(i,t)||t.past&&M(i,t.past))&&this.prepareChild(i)}sort(){this.children.sort((t,i)=>(t=t.zIndex||0,i=i.zIndex||0,+(t>i)||-(t<i)))}draw(){let t=this.ctx;this.children.forEach(i=>{i.frame&&i.frame(t),i.dirty&&i.visible!==!1&&i.draw(t),i.dirty=!1})}elementFromPoint(t,i){let s,n={x:t,y:i,w:1,h:1};return this.children.forEach(o=>{o.visible===!1||!o.w||!o.h||o.pointerEvents===!1||M(n,o)&&(s=o)}),s}addEventListener(t,i){t in this.events||(this.events[t]=[]),this.events[t].push(i)}dispatchEvent(t){t.type in this.events&&this.events[t.type].forEach(i=>i(t))}_findAndDispatch(t){if(typeof MouseEvent<"u"&&t instanceof MouseEvent||typeof TouchEvent<"u"&&t instanceof TouchEvent){let i={x:t.offsetX,y:t.offsetY,w:1,h:1};this.children.forEach(s=>{!s.visible||!s.w||!s.h||!s.pointerEvents||M(i,s)&&s.dispatchEvent(t)})}}};function M(e,t){return!(e.x>t.x+t.w||e.x+e.w<t.x||e.y>t.y+t.h||e.y+e.h<t.y)}function nt(e,t){return e.x!==t.x||e.y!==t.y||e.w!==t.w||e.h!==t.h}var v=class{constructor(...t){this.events=[],this.previous={},t.length&&this.position(...t)}get x(){return this._x}set x(t){this.positionObj({x:t})}get y(){return this._y}set y(t){this.positionObj({y:t})}get w(){return this._w}set w(t){this.positionObj({w:t})}get h(){return this._h}set h(t){this.positionObj({h:t})}get dx(){return this._dx}set dx(t){this._dx!==t&&(this.dirty=!0,this._dx=t)}get dy(){return this._dy}set dy(t){this._dy!==t&&(this.dirty=!0,this._dy=t)}get visible(){return this._visible===void 0?!0:this._visible}set visible(t){this._visible!==t&&(this.dirty=!0,this._visible=t)}get opacity(){return this._opacity===void 0?1:this._opacity}set opacity(t){this._opacity!==t&&(this.dirty=!0,this._opacity=t)}set dirty(t){!this._dirty&&t?(this._dirty=t,this.dispatchEvent(w("dirty"))):t||(this._dirty=t,this.previous={x:this._x,y:this._y,w:this._w,h:this._h})}get dirty(){return this._dirty}get pointerEvents(){return this._pointerEvents===void 0?1:this._pointerEvents}set pointerEvents(t){this._pointerEvents=t}remove(){this.dirty=!0,this.visible=!1}position(t=0,i=0,s=0,n=0){this.positionObj({x:t,y:i,w:s,h:n})}positionObj(t){for(let i in t){let s=t[i];this[`_${i}`]!==s&&(this.dirty=!0,this[`_${i}`]=s)}}frame(){}draw(){}setup(){}addEventListener(t,i){t in this.events||(this.events[t]=[]),this.events[t].push(i)}dispatchEvent(t){t.type in this.events&&this.events[t.type].forEach(i=>i(t))}_watchProperty(t){Object.defineProperty(this,t,{get:this._getter.bind(this,t),set:this._setter.bind(this,t)})}_getter(t){return this[`_${t}`]}_setter(t,i){this[`_${t}`]!==i&&(this.dirty=!0,this[`_${t}`]=i)}};var u=class extends v{constructor(t){super(),["text","shadowBlur","shadowColor","fillStyle","strokeStyle","textAlign","textBaseline","lineWidth"].forEach(this._watchProperty.bind(this)),this.text=t||"",this.shadowColor="black",this.fillStyle="black",this.strokeStyle="white",this.textAlign="left",this.textBaseline="top",this.lineWidth=0,this.align="left top",this.fontSize=30}calc(t){[this.textAlign,this.textBaseline]=this.align.split(" ");let i=t.ctx,s=this.fontSize;this.lines=this.text.toString().split(`
`);let n=0,o=this.lines[0];for(this.lines.forEach(l=>{let h=i.measureText(l).width;h>n&&(n=h,o=l)}),i.save(),i.shadowColor="black",i.fillStyle="black",i.strokeStyle="rgba(255,255,255,0.5)",i.font=`bold ${s}px Arial`;i.measureText(o).width>t.width;)s*=.9,s=Math.round(s),i.font=`bold ${s}px Arial`;switch(this.shadowBlur=i.shadowBlur=Math.round(s/10),this.fontSize=s,this.font=i.font,this.w=i.measureText(o).width+this.shadowBlur*2,this.h=(s+this.shadowBlur*2)*this.lines.length,i.restore(),this.lineWidth=Math.floor(s/60),this.textAlign){case"center":case"middle":this.textAlign="center",this.x=t.width/2-this.w/2;break;case"left":this.x=0;break;case"right":this.x=t.width-this.w;break}switch(this.textBaseline){case"center":case"middle":this.textBaseline="middle",this.y=t.height/2-this.h/2;break;case"top":this.y=0;break;case"bottom":this.y=t.height-this.h;break}this.textAlign="left",this.textBaseline="top",i.restore()}draw(t){t.save(),t.globalAlpha=this.opacity,t.shadowColor=this.shadowColor,this.shadowBlur&&(t.shadowBlur=this.shadowBlur),t.fillStyle=this.fillStyle,t.strokeStyle=this.strokeStyle,t.font=this.font,t.textAlign=this.textAlign,t.textBaseline=this.textBaseline,t.lineWidth=this.lineWidth,this.lineWidth&&(t.lineWidth=this.lineWidth),this.lines=this.text.toString().split(`
`);let i=this.lines.length;this.lines.forEach((s,n)=>{let o=this.y+(this.h?n*(this.h/i):0);t.fillText(s,this.x,o),this.strokeStyle&&t.strokeText(s,this.x,o)}),t.restore()}};var E=class{constructor(t,i){this.items=Array.isArray(t)?t:[],this.handler=i}push(...t){t.forEach(i=>this.items.push(i)),this._handler&&t.forEach(i=>this._handler(i))}get length(){return this.items.length}set length(t){this.items.length=t}get handler(){return this._handler}set handler(t){this._handler=t,this._handler&&this.items.forEach(i=>this._handler(i))}};var ot=window.background=new E(window.background);function ht(e){e(p)}var p=class e{static add(t){e.stages.push(t),e.stages.length===1&&(ot.handler=ht)}static init(t){let i=e.stages[0];if(i)return new i(t)}};p.stages=[];function I(e,...t){return t.forEach(i=>{if(Array.isArray(e)&&Array.isArray(i))Array.prototype.push.apply(e,i);else if(f(e,Object)&&f(i,Object)&&e!==i)for(let s in i)s==="__proto__"||s==="constructor"||(e[s]=I(e[s],i[s]));else Array.isArray(i)?e=i.slice(0):e=i}),e}var W=I;var B=class{constructor(...t){this.position(...t),this.mine=Math.random()<1/8,this.played=!1,this.grid=[0,0],this.fillStyle="#ccc",this.heat=0}position(t,i,s,n){this.x=t,this.y=i,this.w=s,this.h=n,this.dirty=!0}setup(){}frame(){}draw(t){t.fillStyle=this.fillStyle,t.fillRect(this.x,this.y,this.w,this.h)}get type(){return"tile"}},O=class{constructor(){this.options={controls:!0},this.tiles=[],this.mines=[],this.flooded=0,this.boom=!1,this.ended=!1;let t=new b;this.canvas=t;let i=new _(t.target);this.collection=i;let s=new u;s.text="MineField",s.align="center center",s.fontSize=150,s.zIndex=1,s.calc(t),s.pointerEvents=!1,this.title=s;let n=new u;n.text="Tap  to  start",n.align="center center",n.fontSize=40,n.zIndex=1,n.calc(t),n.pointerEvents=!1,n.y=n.y+s.h,this.info=n;let o=new u;o.align="center center",o.zIndex=1,o.fontSize=150,o.calc(t),o.pointerEvents=!1,this.credits=o,t.addEventListener("click",l=>rt.call(this,l.offsetX,l.offsetY)),t.addEventListener("resize",P.bind(this)),t.addEventListener("frame",()=>{i.prepare(),i.draw()})}setup(t){this.config(t),P.call(this)}config(t){W(this.options,t),C.call(this)}};p.add(O);function rt(e,t){if(this.ended){P.call(this);return}let i=this.collection.elementFromPoint(e,t);i&&i.type==="tile"&&lt.call(this,i)}function P(){let e=this.canvas,t=this.collection,i=this.tiles,s=this.mines;this.mines.length=0,this.flooded=0,this.boom=!1,this.ended=!1,i.length=0,t.length=0;let n,o;o=n=50;let l=Math.floor(e.width/o),h=Math.floor(e.height/n);this.nx=l,this.ny=h,o+=Math.floor(e.width%(l*o)/l),n+=Math.floor(e.height%(h*n)/h);for(let g=0;g<h;g++)for(let A=0;A<l;A++){let y=new B(A*o,g*n,o-1,n-1);y.grid=[A,g],i.push(y),t.push(y),y.mine&&s.push(y)}let r=this.credits,d=this.info,a=this.title;t.push(a),t.push(r),t.push(d),C.call(this),r.visible=!1,t.sort()}function lt(e){let t=this.mines,i=this.tiles,s=this.credits,n=this.info,o=this.title;if(!e)return!0;this.flooded===0&&(e.mine=!1),e.mine?this.boom=!0:e.played||$.call(this,e),this.flooded+t.length===i.length||this.boom?(t.forEach(l=>U.call(this,l)),this.ended=!0,s.text=this.boom?"BOOM!":"Kudos!",s.calc(this.canvas),n.text="Tap to restart",C.call(this)):(o.visible=!1,n.visible=!1,s.visible=!1)}function $(e){let t=this.nx,i=this.ny,s=this.tiles,[n,o]=e.grid;if(e.played)return;this.flooded++;let l=[Math.max(o-1,0)*t+Math.max(n-1,0),Math.max(o-1,0)*t+n,Math.max(o-1,0)*t+Math.min(n+1,t-1),o*t+Math.min(n+1,t-1),Math.min(o+1,i-1)*t+Math.min(n+1,t-1),Math.min(o+1,i-1)*t+n,Math.min(o+1,i-1)*t+Math.max(n-1,0),o*t+Math.max(n-1,0)].filter((h,r,d)=>d.indexOf(h)===r&&s[h]).map(h=>s[h]);l.forEach(h=>{e.heat+=+h.mine}),e.played=!0,U.call(this,e),e.heat===0&&l.forEach($.bind(this))}function U(e){if(e.fillStyle=e.mine?"red":"rgba(0,0,0,0.1)",e.dirty=!0,e.heat){let t=new u;t.text=e.heat,t.textBaseline="middle",t.textAlign="center",t.strokeStyle=null,t.fillStyle="black",t.font="bold 30px Arial",t.x=e.x+e.w/2,t.y=e.y+e.h/2,t.w=0,t.h=0,this.collection.push(t),this.collection.sort()}}function C(){let e=this.options.controls,t=!(this.flooded===0||this.boom||this.ended);this.title.visible=this.flooded===0&&!this.ended&&e,this.info.visible=!t&&e,this.credits.visible=this.ended&&e}})();
//# sourceMappingURL=mineField.js.map
