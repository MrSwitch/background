(()=>{window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||(i=>setTimeout(i,1e3/60));var st=window.requestAnimationFrame.bind(window);var B={bubbles:!0,cancelable:!0},T=(i,t=B)=>new Event(i,t);try{T("test")}catch{T=(i,t=B)=>{let e=document.createEvent("Event");return e.initEvent(i,!!t.bubbles,!!t.cancelable),e}}var m=T;var P=i=>(i.stopPropagation=()=>{},i.preventDefault=()=>{},i);var y=(i,t)=>t&&i instanceof t;var q=typeof HTMLElement<"u"&&HTMLElement||typeof Element<"u"&&Element,H=typeof HTMLDocument<"u"&&HTMLDocument||typeof Document<"u"&&Document,$=window.constructor,Y=i=>y(i,q)||y(i,H)||y(i,$);function F(i){return Array.prototype.slice.call(i)}var C=F;function w(i,t=()=>{}){return Y(i)?i=[i]:typeof i=="string"&&(i=document.querySelectorAll(i)),y(i,Array)||(i=C(i)),t&&i.forEach(t),i}var W=/[\s,]+/,O=!1;try{let i=Object.defineProperty({},"passive",{get(){O=!0}});window.addEventListener("test",null,i)}catch{}function d(i,t,e,s=!1){return typeof s=="object"&&s.passive&&!O&&(s=!1),t=t.split(W),w(i,h=>t.forEach(r=>h.addEventListener(r,e,s)))}var k=window.navigator.pointerEnabled,G=k?"MSPointerMove pointerMove":"mousemove touchmove",U=k?"MSPointerDown pointerDown":"mousedown touchstart",V=k?"MSPointerUp pointerUp":"mouseup touchend touchcancel";function A(i,t,e,s){let h={},r={},c={};d(document,G,n=>{if(K(n))return;let o=n.pointerId||0,l=h[o];if(l&&typeof l=="function"){let f=r[o];x(n,f),l(n,f)}r[o]=n}),d(document,V,n=>{let o=n.pointerId||0;h[o]=null,(n.type==="touchend"||n.type==="touchcancel")&&(n=r[o]);let l=c[o];l&&l(n),c[o]=null}),w(i,n=>{d(n,"selectstart",()=>!1),d(n,U,o=>{let l=o.pointerId||0;x(o),r[l]=o,h[l]=(f,j)=>{t.call(n,f,j,o)},s&&(c[l]=f=>{x(f,o),s.call(n,f,o)}),e&&e.call(n,o)})})}function x(i,t){if(i.gesture={},i&&i.touches&&i.touches.length>0?i.gesture.touches=i.touches:i.gesture.touches=[i],i.gesture.screenX=i.gesture.touches[0].screenX,i.gesture.screenY=i.gesture.touches[0].screenY,"screenX"in i||(i.screenX=i.gesture.screenX),"screenY"in i||(i.screenY=i.gesture.screenY),t){i.gesture.deltaTime=i.timeStamp-t.timeStamp;let e=i.gesture.deltaX=i.gesture.screenX-t.gesture.screenX,s=i.gesture.deltaY=i.gesture.screenY-t.gesture.screenY;Math.abs(s)>Math.abs(e)?i.gesture.direction=s>0?"up":"down":i.gesture.direction=e>0?"right":"left",i.gesture.distance=Math.sqrt(e*e+s*s),i.gesture.velocity=i.gesture.distance/i.gesture.deltaTime}}function K(i){return(i.pointerType||i.type).match(/mouse/i)&&(i.which||i.buttons)!==1}function M(i,t){return A(i,function(s,h,r){x(s,r),s.gesture.type=`drag${s.gesture.direction}`,t.call(this,s)},function(s){s.gesture.type="start",t.call(this,s)},function(s){let h=s.gesture;h.deltaTime<200&&h.distance>20&&h.velocity>.3?h.type=`swipe${h.direction}`:h.distance<20?h.type="click":h.type="release",t.call(this,s)})}var I="background",X=["click","mousedown","mouseup","mouseover","mousemove","mouseout","frame","resize","keydown"],D=["touchmove","touchstart","touchend"],Z=/[\s,]+/,b=class{constructor(t){let e;if(this.events={},"getContext"in document.createElement("canvas")){t&&t instanceof HTMLCanvasElement?(this.target=t,e=t.parentNode):(e=t,t=document.createElement("canvas"),t.style.backgroundColor="white",e||(e=document.body,t.style.cssText="position:fixed;z-index:-1;top:0;left:0;",t.setAttribute("tabindex",0),document.documentElement.style.cssText="min-height:100%;",document.body.style.cssText="min-height:100%;",window.addEventListener("resize",this.resize.bind(this))),e.insertBefore(t,e.firstElementChild),this.target=t,this.resize()),this.ctx=t.getContext("2d"),this.ctx.save(),this._time=0,this._fps=0,this.draw(),d(this.target,X.toString(),this.dispatchEvent.bind(this),{passive:!0}),d(this.target,D.toString(),this.dispatchTouchEvent.bind(this),{passive:!0}),e===document.body&&t.style.getPropertyValue("z-index")==="-1"&&(d(document,X.toString(),this.dispatchEvent.bind(this),{passive:!0}),d(document,D.toString(),this.dispatchTouchEvent.bind(this),{passive:!0}));{let s=this.target.style,h=s.getPropertyValue("z-index");window.addEventListener("hashchange",R.bind(s,h)),R.call(s,h)}this.swipe&&M(this.target,this.swipe.bind(this))}}get width(){return this.target.width}set width(t){this.target.width=t}get height(){return this.target.height}set height(t){this.target.height=t}get fps(){return this._fps}set fps(t){this._fps=t;let e=new Date().getTime();e-this._time>1e3&&(this._time=e,this._fps=0)}resize(){let t=this.target.parentNode===document.body?document.documentElement:this.target.parentNode,e=t.clientHeight,s=t.clientWidth,h=!1;this.width!==s&&(h=!0,this.width=s),this.height!==e&&(h=!0,this.height=e),h&&this.target.dispatchEvent(m("resize"))}clear(){this.ctx.clearRect(0,0,this.target.width,this.target.height)}bringToFront(){window.location.hash=I}draw(){this.fps++,this.target.dispatchEvent(m("frame")),requestAnimationFrame(this.draw.bind(this))}addEventListener(t,e){t.split(Z).forEach(s=>{s in this.events||(this.events[s]=[]),this.events[s].push(e)})}dispatchEvent(t){t.type in this.events&&(t.currentTarget===document&&(t=P({type:t.type,target:this.target,offsetX:t.pageX||t.offsetX,offsetY:t.pageY||t.offsetY})),this.events[t.type].forEach(s=>s(t)),t.stopPropagation())}dispatchTouchEvent(t){let e=(t.touches||t.changedTouches)[0];e&&(t.offsetX=Math.abs(e.pageX||e.screenX),t.offsetY=Math.abs(e.pageY||e.screenY)),this.dispatchEvent(t)}};function R(i){let t="z-index";window.location.hash===`#${I}`&&(i=1e4),i!==void 0?this.setProperty(t,i):this.removeProperty(t)}var J=["click","mousedown","mouseup","mouseover","mousemove","mouseout","touchmove","touchstart","touchend","frame"],_=class{constructor(t){this.children=[],this.events=[],this.init(t)}init(t){this.target=t,this.ctx=t.getContext("2d"),d(t,J.toString(),this._findAndDispatch.bind(this),{passive:!0})}push(t){t.dirty=!0,this.children.indexOf(t)===-1&&(t.setup&&t.setup(this),this.children.push(t))}findIndex(t){return this.children.findIndex(t)}find(t){return this.children.find(t)}get length(){return this.children.length}set length(t){this.children.length=t}prepare(){this.children.forEach(t=>{t.dirty===!0&&this.prepareChild(t)})}prepareChild(t){let e=this.ctx;t.dirty!=="pending"&&(t.dirty="pending",e.clearRect(t.x,t.y,t.w,t.h),t.previous&&N(t.previous,t)&&e.clearRect(t.previous.x,t.previous.y,t.previous.w,t.previous.h),this.children.forEach(this._prepareSiblings.bind(this,t)))}_prepareSiblings(t,e){!e.dirty&&e.visible!==!1&&(S(e,t)||t.past&&S(e,t.past))&&this.prepareChild(e)}sort(){this.children.sort((t,e)=>(t=t.zIndex||0,e=e.zIndex||0,+(t>e)||-(t<e)))}draw(){let t=this.ctx;this.children.forEach(e=>{e.frame&&e.frame(t),e.dirty&&e.visible!==!1&&e.draw(t),e.dirty=!1})}elementFromPoint(t,e){let s,h={x:t,y:e,w:1,h:1};return this.children.forEach(r=>{r.visible===!1||!r.w||!r.h||r.pointerEvents===!1||S(h,r)&&(s=r)}),s}addEventListener(t,e){t in this.events||(this.events[t]=[]),this.events[t].push(e)}dispatchEvent(t){t.type in this.events&&this.events[t.type].forEach(e=>e(t))}_findAndDispatch(t){if(typeof MouseEvent<"u"&&t instanceof MouseEvent||typeof TouchEvent<"u"&&t instanceof TouchEvent){let e={x:t.offsetX,y:t.offsetY,w:1,h:1};this.children.forEach(s=>{!s.visible||!s.w||!s.h||!s.pointerEvents||S(e,s)&&s.dispatchEvent(t)})}}};function S(i,t){return!(i.x>t.x+t.w||i.x+i.w<t.x||i.y>t.y+t.h||i.y+i.h<t.y)}function N(i,t){return i.x!==t.x||i.y!==t.y||i.w!==t.w||i.h!==t.h}var u=class{constructor(...t){this.events=[],this.previous={},t.length&&this.position(...t)}get x(){return this._x}set x(t){this.positionObj({x:t})}get y(){return this._y}set y(t){this.positionObj({y:t})}get w(){return this._w}set w(t){this.positionObj({w:t})}get h(){return this._h}set h(t){this.positionObj({h:t})}get dx(){return this._dx}set dx(t){this._dx!==t&&(this.dirty=!0,this._dx=t)}get dy(){return this._dy}set dy(t){this._dy!==t&&(this.dirty=!0,this._dy=t)}get visible(){return this._visible===void 0?!0:this._visible}set visible(t){this._visible!==t&&(this.dirty=!0,this._visible=t)}get opacity(){return this._opacity===void 0?1:this._opacity}set opacity(t){this._opacity!==t&&(this.dirty=!0,this._opacity=t)}set dirty(t){!this._dirty&&t?(this._dirty=t,this.dispatchEvent(m("dirty"))):t||(this._dirty=t,this.previous={x:this._x,y:this._y,w:this._w,h:this._h})}get dirty(){return this._dirty}get pointerEvents(){return this._pointerEvents===void 0?1:this._pointerEvents}set pointerEvents(t){this._pointerEvents=t}remove(){this.dirty=!0,this.visible=!1}position(t=0,e=0,s=0,h=0){this.positionObj({x:t,y:e,w:s,h})}positionObj(t){for(let e in t){let s=t[e];this[`_${e}`]!==s&&(this.dirty=!0,this[`_${e}`]=s)}}frame(){}draw(){}setup(){}addEventListener(t,e){t in this.events||(this.events[t]=[]),this.events[t].push(e)}dispatchEvent(t){t.type in this.events&&this.events[t.type].forEach(e=>e(t))}_watchProperty(t){Object.defineProperty(this,t,{get:this._getter.bind(this,t),set:this._setter.bind(this,t)})}_getter(t){return this[`_${t}`]}_setter(t,e){this[`_${t}`]!==e&&(this.dirty=!0,this[`_${t}`]=e)}};var p=class extends u{constructor(t){super(),["text","shadowBlur","shadowColor","fillStyle","strokeStyle","textAlign","textBaseline","lineWidth"].forEach(this._watchProperty.bind(this)),this.text=t||"",this.shadowColor="black",this.fillStyle="black",this.strokeStyle="white",this.textAlign="left",this.textBaseline="top",this.lineWidth=0,this.align="left top",this.fontSize=30}calc(t){[this.textAlign,this.textBaseline]=this.align.split(" ");let e=t.ctx,s=this.fontSize;this.lines=this.text.toString().split(`
`);let h=0,r=this.lines[0];for(this.lines.forEach(c=>{let n=e.measureText(c).width;n>h&&(h=n,r=c)}),e.save(),e.shadowColor="black",e.fillStyle="black",e.strokeStyle="rgba(255,255,255,0.5)",e.font=`bold ${s}px Arial`;e.measureText(r).width>t.width;)s*=.9,s=Math.round(s),e.font=`bold ${s}px Arial`;switch(this.shadowBlur=e.shadowBlur=Math.round(s/10),this.fontSize=s,this.font=e.font,this.w=e.measureText(r).width+this.shadowBlur*2,this.h=(s+this.shadowBlur*2)*this.lines.length,e.restore(),this.lineWidth=Math.floor(s/60),this.textAlign){case"center":case"middle":this.textAlign="center",this.x=t.width/2-this.w/2;break;case"left":this.x=0;break;case"right":this.x=t.width-this.w;break}switch(this.textBaseline){case"center":case"middle":this.textBaseline="middle",this.y=t.height/2-this.h/2;break;case"top":this.y=0;break;case"bottom":this.y=t.height-this.h;break}this.textAlign="left",this.textBaseline="top",e.restore()}draw(t){t.save(),t.globalAlpha=this.opacity,t.shadowColor=this.shadowColor,this.shadowBlur&&(t.shadowBlur=this.shadowBlur),t.fillStyle=this.fillStyle,t.strokeStyle=this.strokeStyle,t.font=this.font,t.textAlign=this.textAlign,t.textBaseline=this.textBaseline,t.lineWidth=this.lineWidth,this.lineWidth&&(t.lineWidth=this.lineWidth),this.lines=this.text.toString().split(`
`);let e=this.lines.length;this.lines.forEach((s,h)=>{let r=this.y+(this.h?h*(this.h/e):0);t.fillText(s,this.x,r),this.strokeStyle&&t.strokeText(s,this.x,r)}),t.restore()}};var v=class extends u{constructor(...t){super(...t)}get fillStyle(){return this._fillStyle}set fillStyle(t){this._fillStyle!==t&&(this.dirty=!0,this._fillStyle=t)}get type(){return"rect"}draw(t){t.save(),(this.dx||this.dy)&&t.translate(this.dx,this.dy),t.fillStyle=this.fillStyle,t.fillRect(this.x,this.y,this.w,this.h),t.restore()}};var E=class{constructor(t,e){this.items=Array.isArray(t)?t:[],this.handler=e}push(...t){t.forEach(e=>this.items.push(e)),this._handler&&t.forEach(e=>this._handler(e))}get length(){return this.items.length}set length(t){this.items.length=t}get handler(){return this._handler}set handler(t){this._handler=t,this._handler&&this.items.forEach(e=>this._handler(e))}};var Q=window.background=new E(window.background);function tt(i){i(g)}var g=class i{static add(t){i.stages.push(t),i.stages.length===1&&(Q.handler=tt)}static init(t){let e=i.stages[0];if(e)return new e(t)}};g.stages=[];var a={red:"#ff595e",green:"#8ac926",blue:"#1982c4",yellow:"#ffca3a",purple:"#6a4c93",grey:"#999999"},It=[a.red,a.green,a.blue,a.yellow,a.purple,a.grey];var z=class extends u{constructor({gx:t,gy:e,tw:s,th:h,structure:r,color:c}){let n=s*t,o=h*e,l=s*r[0].length,f=h*r.length;super(n,o,l,f),this.tw=s,this.th=h,this.gx=t,this.gy=e,this.zIndex=0,this.color=c,this.structure=r}rotate(){let t=[],e=this.structure.length;this.structure.forEach((s,h)=>{s.forEach((r,c)=>{let n=t[c];n||(n=[],t[c]=n),t[c][e-h-1]=r})}),this.structure=t}points(){let t=[];return this.structure.forEach((e,s)=>{e.forEach((h,r)=>{h&&t.push([r,s])})}),t}draw(t){t.fillStyle=this.color,this.structure.forEach((e,s)=>{let h=s*this.th;e.forEach((r,c)=>{if(r){let n=c*this.tw;t.fillRect(this.x+n,this.y+h,this.tw,this.th)}})})}},et=[{color:a.red,name:"square",structure:[[1,1],[1,1]]},{color:a.green,name:"left-l",structure:[[0,1,0],[0,1,0],[0,1,1]]},{color:a.green,name:"right-l",structure:[[0,1,0],[0,1,0],[1,1,0]]},{color:a.blue,name:"zig",structure:[[1,0,0],[1,1,0],[0,1,0]]},{color:a.yellow,name:"zag",structure:[[0,1,0],[1,1,0],[1,0,0]]},{color:a.purple,name:"line",structure:[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]},{color:a.grey,name:"middle",structure:[[0,1,0],[0,1,1],[0,1,0]]}],L=class extends b{constructor(t){super(t),this.collection=new _(this.target),this.addEventListener("frame",this.frame.bind(this)),this.addEventListener("resize",this.reset.bind(this)),this.options={controls:!0},this.board=[];let e=new p;e.text="Game Over",e.zIndex=1,e.fontSize=150,e.align="center center",e.addEventListener("click",this.reset.bind(this)),e.visible=!1,this.credits=e;let s=new p;s.zIndex=1,s.text=0,s.align="right bottom",s.pointerEvents=!1,s.fontSize=40,this.score=s;let h=new p;h.text="Click to start",h.zIndex=1,h.align="center center",h.fontSize=40,h.calc(this),this.info=h,this.addEventListener("keydown",this.keypress.bind(this)),this.cadence=1e3,this.lastTick=0}setup(t){this.config(t),this.reset()}config(t={}){Object.assign(this.options,t)}reset(){this.ended=!1,this.gamepiece=null;let t=50;this.collection.length=0,this.board.length=0;{this.nx=Math.floor(this.width/t),this.ny=Math.floor(this.height/t),this.tw=t+Math.floor(this.width%(this.nx*t)/this.nx),this.th=t+Math.floor(this.height%(this.ny*t)/this.ny);for(let e=0;e<this.ny;e++){this.board[e]=[];for(let s=0;s<this.nx;s++)this.board[e][s]=null}}this.score.text=0,this.score.calc(this),this.collection.push(this.credits),this.collection.push(this.info),this.collection.push(this.score),this.collection.sort(),this.clear(),this.controls()}controls(){let t=this.options.controls;this.score.visible=t,this.credits.visible=t&&this.ended,this.info.visible=t&&this.ended}frame(){if(!this.ended){let t=performance.now();this.diff=Math.min((t-this.lastTick)/this.cadence,1)%1,this.gamepiece&&(this.gamepiece.y=parseInt((this.diff+this.gamepiece.gy)*this.th,10)),this.diff===0&&(this.lastTick=t,this.tick())}this.collection.prepare(),this.collection.draw()}tick(){if(this.gamepiece)this.move({y:1});else{let{tw:t,th:e,nx:s}=this,h=it(et),r=h.structure[0].length,c=h.structure.length,n=Math.ceil((s-r)/2),o=-c,l=Object.assign({gx:n,gy:o,tw:t,th:e},h);this.gamepiece=new z(l),this.collection.push(this.gamepiece),this.collection.sort()}}click(){this.rotate()}rotate(){this.gamepiece&&this.gamepiece.rotate()}canMove(t){let{gx:e,gy:s}=this.gamepiece,{x:h=0,y:r=0}=t;return!this.gamepiece.points().find(([n,o])=>this.diff&&h&&!r&&this.point(n+h+e,o+r+s+1)?!0:this.point(n+h+e,o+r+s))}point(t,e){return e<0?null:e>=this.ny||t<0||t>=this.nx?1:this.board[e][t]}restGamepiece(){let t=this.gamepiece.points(),{gx:e,gy:s}=this.gamepiece;if(s<=0){this.end();return}t.forEach(([r,c])=>{let n=r+e,o=c+s,l=new v(this.tw*n,this.th*o,this.tw,this.th);l.zIndex=0,l.fillStyle=this.gamepiece.color,this.collection.push(l),this.board[o][n]=l}),this.gamepiece.remove(),this.swipeStart=null;let h=[];this.board.forEach((r,c)=>{r.filter(n=>n).length===this.nx&&(r.forEach(n=>n.remove()),h.push(c))}),h.length&&(h.reverse().forEach(r=>this.board.splice(r,1)),h.forEach(()=>{this.board.unshift([])}),this.board.forEach((r,c)=>{r.forEach(n=>{n&&(n.y=c*this.th)})}),this.score.text+=h.length,this.score.calc(this))}move({x:t=0,y:e=0}){if(this.gamepiece&&this.canMove({x:t,y:e}))return this.gamepiece.gx+=t,this.gamepiece.x=this.gamepiece.gx*this.tw,this.gamepiece.gy+=e,this.gamepiece.y=this.gamepiece.gy*this.th,this.canMove({y:1})||(this.restGamepiece(),this.gamepiece=null),!0}keypress({key:t}){switch(t){case"ArrowRight":{this.move({x:1});break}case"ArrowLeft":{this.move({x:-1});break}case"ArrowDown":{this.move({y:1});break}case"ArrowUp":{this.rotate();break}case" ":this.rotate()}}swipe(t){typeof TouchEvent<"u"&&t instanceof TouchEvent&&t.preventDefault();let e=t.gesture.type;if(e==="start"&&this.ended){this.reset();return}if(e==="release"||e==="click"||!this.gamepiece){if(this.swipeStart=null,t.gesture.deltaTime<200){this.rotate();return}return}if(e==="start"){this.swipeStartGamePiece=this.gamepiece;return}if(this.swipeStartGamePiece!==this.gamepiece)return;this.swipeStart||(this.swipeStart={x:this.gamepiece.gx,y:this.gamepiece.gy});let s=parseInt(t.gesture.deltaX/this.tw,10),h=parseInt(t.gesture.deltaY/this.th,10),r=this.swipeStart.x-this.gamepiece.gx+s,c=Math.max(this.swipeStart.y-this.gamepiece.gy+h,0);this.move({x:r,y:c})}end(){this.ended=!0,this.controls(),this.credits.calc(this),this.info.calc(this),this.info.y=this.info.y+this.credits.h,this.info.text=`You scored ${this.score.text}`}};g.add(L);function it(i){return i[Math.floor(i.length*Math.random())]}})();
//# sourceMappingURL=tetris.js.map
